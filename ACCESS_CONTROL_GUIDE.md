# Руководство по контролю доступа

## Обзор

Система контроля доступа ограничивает использование приложения только мобильными устройствами, с исключениями для localhost и определенных пользователей.

## Правила доступа

### Разрешенный доступ:
1. **Мобильные устройства** - телефоны, планшеты
2. **Localhost** - разработка и тестирование
3. **Разрешенные пользователи** - пользователи с определенными номерами телефонов

### Запрещенный доступ:
- Десктопные браузеры (кроме localhost)
- Пользователи без разрешенных номеров телефонов

## Разрешенные номера телефонов

По умолчанию разрешен доступ для:
- `+998336832000`

Для добавления новых номеров отредактируйте массив `ALLOWED_PHONE_NUMBERS` в файле `src/utils/deviceValidation.js`:

```javascript
const ALLOWED_PHONE_NUMBERS = [
  '+998336832000',
  '+998901234567', // добавьте новый номер
  // ... другие номера
];
```

## Определение мобильного устройства

Система определяет мобильное устройство по следующим критериям:

1. **User Agent** - проверка ключевых слов:
   - mobile, android, iphone, ipad, ipod
   - blackberry, windows phone, opera mini, iemobile

2. **Размер экрана** - ширина <= 768px

3. **Touch события** - поддержка сенсорного ввода

## Компоненты системы

### 1. `deviceValidation.js`
Основные утилиты для проверки доступа:
- `isMobileDevice()` - проверка мобильного устройства
- `isLocalhost()` - проверка localhost
- `getUserPhoneNumber()` - получение номера телефона пользователя
- `isAccessAllowed()` - основная функция проверки доступа

### 2. `useAccessControl.js`
React хук для контроля доступа:
- Проверка доступа при загрузке
- Реакция на изменение размера окна
- Трекинг попыток доступа

### 3. `AccessDeniedScreen.jsx`
Компонент для отображения сообщения об отказе в доступе

### 4. `accessDebug.js`
Утилиты для отладки (только в development режиме)

## Использование

### Автоматическая проверка
Система автоматически проверяет доступ при загрузке приложения и показывает соответствующий экран.

### Ручная проверка
```javascript
import { isAccessAllowed, getDeviceInfo } from '../utils/deviceValidation';

// Проверить доступ
const allowed = isAccessAllowed();

// Получить информацию об устройстве
const deviceInfo = getDeviceInfo();
```

### Использование хука
```javascript
import { useAccessControl } from '../hooks/useAccessControl';

function MyComponent() {
  const { isAllowed, isChecking, deviceInfo } = useAccessControl();

  if (isChecking) {
    return <div>Проверка доступа...</div>;
  }

  if (!isAllowed) {
    return <div>Доступ запрещен</div>;
  }

  return <div>Контент приложения</div>;
}
```

## Отладка

### В development режиме
Доступны глобальные функции в консоли браузера:

```javascript
// Показать подробную информацию
window.debugAccess();

// Проверить доступ с причинами
window.checkAccess();
```

### Логирование
Система автоматически трекает:
- `access_control_check` - проверка доступа
- `access_denied` - отказ в доступе
- `access_denied_after_login` - отказ после входа

### Проверка в консоли
```javascript
// Проверить статус доступа
console.log('Access allowed:', isAccessAllowed());

// Получить информацию об устройстве
console.log('Device info:', getDeviceInfo());

// Проверить номер телефона
console.log('User phone:', getUserPhoneNumber());
```

## Настройка

### Добавление новых разрешенных номеров
1. Откройте `src/utils/deviceValidation.js`
2. Найдите массив `ALLOWED_PHONE_NUMBERS`
3. Добавьте новый номер в формате `+998XXXXXXXXX`

### Изменение правил определения мобильного устройства
1. Откройте `src/utils/deviceValidation.js`
2. Найдите функцию `isMobileDevice()`
3. Измените логику проверки по необходимости

### Кастомизация сообщения об отказе в доступе
1. Откройте `src/components/AccessDeniedScreen.jsx`
2. Измените текст и стили по необходимости

## Тестирование

### Тестирование на мобильном устройстве
1. Откройте приложение на телефоне/планшете
2. Проверьте, что доступ разрешен
3. Проверьте трекинг в консоли

### Тестирование на десктопе
1. Откройте приложение в десктопном браузере
2. Проверьте, что показывается экран отказа в доступе
3. Проверьте трекинг в консоли

### Тестирование localhost
1. Запустите приложение локально
2. Проверьте, что доступ разрешен
3. Проверьте трекинг в консоли

### Тестирование с разрешенным номером
1. Войдите в приложение с номером `+998336832000`
2. Проверьте, что доступ разрешен на любом устройстве
3. Проверьте трекинг в консоли

## Безопасность

### Ограничения
- Проверка выполняется на клиенте
- User Agent можно подделать
- Размер экрана можно изменить

### Рекомендации
- Дополнительная проверка на сервере
- Использование более надежных методов определения устройства
- Логирование всех попыток доступа

## Мониторинг

### Трекинг событий
Система автоматически отслеживает:
- Попытки доступа
- Отказы в доступе
- Информацию об устройстве
- Номера телефонов пользователей

### Аналитика
Используйте трекинг для анализа:
- Количество попыток доступа с десктопа
- Популярные устройства
- Эффективность ограничений

## Устранение неполадок

### Проблема: Доступ запрещен на мобильном устройстве
**Решение:**
1. Проверьте User Agent в консоли
2. Проверьте размер экрана
3. Проверьте поддержку touch событий
4. Используйте `window.debugAccess()` для диагностики

### Проблема: Доступ разрешен на десктопе
**Решение:**
1. Проверьте, не localhost ли это
2. Проверьте номер телефона пользователя
3. Проверьте логику в `isMobileDevice()`

### Проблема: Не работает трекинг
**Решение:**
1. Проверьте, что пользователь аутентифицирован
2. Проверьте наличие `session_id`
3. Проверьте консоль на ошибки

## Примеры использования

### Проверка доступа в компоненте
```javascript
import { useAccessControl } from '../hooks/useAccessControl';

function ProtectedComponent() {
  const { isAllowed, isChecking } = useAccessControl();

  if (isChecking) {
    return <LoadingSpinner />;
  }

  if (!isAllowed) {
    return <AccessDeniedMessage />;
  }

  return <MainContent />;
}
```

### Условный рендеринг
```javascript
import { isAccessAllowed } from '../utils/deviceValidation';

function MyComponent() {
  const canAccess = isAccessAllowed();

  return (
    <div>
      {canAccess ? (
        <MobileOptimizedContent />
      ) : (
        <DesktopMessage />
      )}
    </div>
  );
}
```

### Отладка в development
```javascript
// В консоли браузера
window.debugAccess(); // Показать всю информацию
window.checkAccess(); // Проверить доступ с причинами
```
